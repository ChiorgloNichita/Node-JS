# Лабораторная работа №2. Работа с базой данных

## Цель работы

1. Научиться проектировать и реализовывать REST API с несколькими связанными сущностями.
2. Освоить работу с PostgreSQL в приложении на Node.js + Express с использованием ORM или сырых SQL-запросов.
3. Реализовать корректные операции CRUD, а также фильтрацию, сортировку и пагинацию.
4. Освоить принципы работы связей «один ко многим» (1:N) в реляционных базах данных.

## Условие

Разработать сервис для управления задачами (todo list) с возможностью:

- Просмотра списка задач.
- Создания новой задачи.
- Переключения статуса задачи (выполнена/не выполнена).
- Удаления задачи.
- Редактирования задачи.
- Фильтрации задач по категориям.
- Поиска задач по заголовку.
- Пагинации списка задач.

## Структура проекта

```
todo-app-2/
├── prisma/
│   ├── schema.prisma         # модели Category и Todo
│
├── controllers/
│   ├── categoryController.js # CRUD операции для категорий
│   └── todoController.js     # CRUD операции для задач
│
├── routes/
│   └── api.js                # маршруты API
│
├── models/
│   └── db.js                 # подключение к Prisma Client
│
├── .env                      # DATABASE_URL и PORT
├── app.js                    # главный файл приложения
└── package.json              # зависимости и скрипты
```

## Реализованные модели

Файл: `prisma/schema.prisma`

```prisma
model Category {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  todos      Todo[]
}

model Todo {
  id          String    @id @default(uuid())
  title       String    @db.VarChar(120)
  completed   Boolean   @default(false)
  category_id Int?
  due_date    DateTime?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  category    Category? @relation(fields: [category_id], references: [id], onDelete: SetNull)
}
```

После выполнения команды:

```bash
npx dotenv -e .env -- prisma migrate dev --name init_lab3
```

таблицы `Category` и `Todo` успешно созданы в базе данных.

---

## Реализованные маршруты API

Файл: `routes/api.js`

| Метод      | URL                     | Описание                     | Код       |
| ---------- | ----------------------- | ---------------------------- | --------- |
| **GET**    | `/api/categories`       | Получить список категорий    | 200       |
| **GET**    | `/api/categories/:id`   | Получить категорию по ID     | 200 / 404 |
| **POST**   | `/api/categories`       | Создать категорию            | 201       |
| **PUT**    | `/api/categories/:id`   | Обновить категорию           | 200 / 404 |
| **DELETE** | `/api/categories/:id`   | Удалить категорию            | 204 / 404 |
| **GET**    | `/api/todos`            | Получить список задач        | 200       |
| **GET**    | `/api/todos/:id`        | Получить задачу по ID        | 200 / 404 |
| **POST**   | `/api/todos`            | Создать задачу               | 201       |
| **PUT**    | `/api/todos/:id`        | Обновить задачу              | 200 / 404 |
| **PATCH**  | `/api/todos/:id/toggle` | Переключить статус completed | 200 / 404 |
| **DELETE** | `/api/todos/:id`        | Удалить задачу               | 204 / 404 |

## Примеры запросов в Postman

### 1. Создание категории

**POST** → `http://localhost:3000/api/categories`
**Body → JSON:**

```json
{ "name": "Учёба" }
```

**Ответ:**

```json
{
  "id": 1,
  "name": "Учёба",
  "created_at": "2025-10-27T20:00:00.000Z",
  "updated_at": "2025-10-27T20:00:00.000Z"
}
```

![alt text](image.png)

### 2. Получение списка категорий

**GET** → `http://localhost:3000/api/categories`
**Body:** _(не требуется)_
**Ответ:**

```json
[
  { "id": 1, "name": "Учёба" },
  { "id": 2, "name": "Покупки" }
]
```

---

### 3. Создание задачи

**POST** → `http://localhost:3000/api/todos`
**Body → JSON:**

```json
{
  "title": "Сделать лабораторную работу",
  "category_id": 1
}
```

**Ответ:**

```json
{
  "id": "uuid",
  "title": "Сделать лабораторную работу",
  "completed": false,
  "category_id": 1,
  "created_at": "2025-10-27T20:01:00.000Z"
}
```

![alt text](image-1.png)

### 4. Переключение статуса задачи

**PATCH** → `http://localhost:3000/api/todos/:id/toggle`

---

### 5. Удаление задачи

**DELETE** → `http://localhost:3000/api/todos/:id`

![alt text](image-2.png)

## Результат работы

- Реализовано REST API для двух сущностей: **Category** и **Todo**.
- Весь CRUD функционал проверен через **Postman**.
- Все запросы возвращают корректные HTTP-коды (`200`, `201`, `204`, `404`, `500`).
- Реализована валидация длины названия задач.
- База данных PostgreSQL успешно взаимодействует с приложением через **Prisma Client**.

# Контрольные вопросы

1. **Что такое реляционная база данных и какие преимущества она предоставляет?**
   РБД - хранилище данных в виде таблиц с отношениями между ними (строки - записи, столбцы - поля).
   **Преимущества:** целостность данных (ключи, транзакции), удобный SQL-доступ, нормализация, масштабируемость для OLTP.

2. **Какие типы связей между таблицами существуют?**

   - **1:1** - одна запись ↔ одна запись.
   - **1:N (один ко многим)** - одна запись ↔ много записей.
   - **M:N (многие ко многим)** - через связующую таблицу.

3. **Что такое RESTful API и для чего он используется?**
   REST - архитектурный стиль для веб-сервисов: ресурсы по URL, стандартные методы HTTP (GET/POST/PUT/DELETE).
   Используется для обмена данными между клиентом и сервером простым, предсказуемым способом.

4. **Что такое SQL-инъекция и как защититься от неё?**
   SQL-инъекция - вставка вредоносного SQL через ввод пользователя.
   **Защита:** подготовленные выражения (prepared statements / параметризованные запросы), валидация/экранирование ввода, минимальные привилегии БД.

5. **В чем разница между ORM и сырыми SQL-запросами?**

   - **ORM:** сопоставляет объекты таблицы; быстрее писать, меньше boilerplate, абстракция транзакций.
     **Минусы:** возможны неэффективные запросы, сложнее тонкая оптимизация.
   - **Сырые SQL:** полный контроль над запросами и производительностью.
     **Минусы:** больше кода, риск ошибок, дублирование логики.

## Вывод

В ходе выполнения лабораторной работы я научился:

- создавать серверные приложения на **Express.js**;
- использовать ORM **Prisma** для связи с базой данных PostgreSQL;
- реализовывать RESTful API с методами **GET, POST, PUT, PATCH, DELETE**;
- тестировать API с помощью **Postman**;
- работать с переменными окружения и структурировать код по папкам (MVC).
