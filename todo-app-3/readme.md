# Лабораторная работа №3. Аутентификация и авторизация

## Цель работы

1. Освоить методы аутентификации и авторизации в backend-приложениях на Node.js.
2. Реализовать защиту REST API с помощью JWT (JSON Web Token).
3. Научиться разграничивать доступ к ресурсам в зависимости от роли пользователя.

## Условие

Модифицировать существующий сервис ToDo REST API, добавив систему пользователей и механизм JWT-аутентификации.

Сервис должен поддерживать:

- регистрацию и вход пользователей;
- получение JWT-токена при успешном входе;
- использование токена для доступа к защищённым ресурсам (`/api/todos`, `/api/categories`);
- разграничение прав пользователей (администратор может управлять всеми, обычный — только своими).

## 3. Модификация структуры базы данных

Для возможности идентификации пользователей была добавлена таблица `users`:

| Поле       | Тип          | Описание                              |
| ---------- | ------------ | ------------------------------------- |
| id         | SERIAL (PK)  | Уникальный идентификатор пользователя |
| username   | VARCHAR(50)  | Имя пользователя (уникальное)         |
| email      | VARCHAR(100) | Email пользователя (уникальный)       |
| password   | TEXT         | Хэш пароля                            |
| role       | VARCHAR(20)  | Роль (`user` или `admin`)             |
| created_at | TIMESTAMP    | Дата создания                         |
| updated_at | TIMESTAMP    | Дата изменения                        |

Изменения в таблице `todos`:

| Поле    | Тип        | Описание                                    |
| ------- | ---------- | ------------------------------------------- |
| user_id | INTEGER FK | Идентификатор пользователя-владельца задачи |

Таким образом каждая задача привязана к определённому пользователю.

## 4. Реализация аутентификации (Authentication)

Добавлены маршруты модуля `/api/auth`:

| Метод | Маршрут              | Назначение                                  |
| ----- | -------------------- | ------------------------------------------- |
| POST  | `/api/auth/register` | Регистрация нового пользователя             |
| POST  | `/api/auth/login`    | Вход и получение JWT-токена                 |
| GET   | `/api/auth/profile`  | Получение информации о текущем пользователе |

## Шаг 2. Реализация аутентификации (Authentication)

### 1. Регистрация пользователя (`POST /api/auth/register`)

- Проверяется уникальность `username` и `email`.
- Пароль хэшируется с помощью `bcrypt`.
- Создаётся запись в таблице `users`.

Пример запроса:

```json
{
  "username": "nik",
  "email": "nik@mail.com",
  "password": "12345"
}
```

![alt text](image-2.png)

### 2. Вход пользователя (`POST /api/auth/login`)

- Проверяется существование пользователя.
- Сверяется введённый пароль с хэшем.
- Генерируется JWT-токен, содержащий:

  - `userId`
  - `username`
  - `role`

Пример ответа:

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJuYW1lIjoiYWRtaW4iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NjI3NjQwNzksImV4cCI6MTc2Mjg1MDQ3OX0.-qMN-mSPrsrUCxxF1tC6YcHs9VrHrkQcBNKFey7naG8"
}
```

![alt text](image.png)

### 3. Получение данных текущего пользователя (`GET /api/auth/profile`)

**Токен передаётся в заголовке:**

```
Authorization: Bearer <token>
```

- Если токен валиден → сервер возвращает информацию о пользователе.
- Если токен отсутствует или неверный → `401 Unauthorized`.

Пример ответа:

```json
{
  "username": "admin",
  "email": "admin@mail.com",
  "password": "12345",
  "role": "admin"
}
```

![alt text](image-1.png)

## Шаг 3. Реализация авторизации (Authorization)

### 1. Middleware проверки JWT (`passport.authenticate("jwt")`)

- Если токен отсутствует → `401 Unauthorized`.
- Если токен валиден → данные пользователя доступны в `req.user`.

### 2. Разграничение доступа по ролям

**Middleware `isAdmin`**

- Доступ разрешён только если `req.user.role === "admin"`.

**Middleware `isOwnerOrAdmin`**

- Разрешает доступ если:

  - пользователь владелец ресурса (`todo.user_id === req.user.id`), или
  - роль пользователя — `admin`.

### Политика действий по ролям

**Обычный пользователь (`role=user`):**

- Может создавать задачи: `POST /api/todos`
- Может просматривать задачи: `GET /api/todos`
- Может изменять и удалять **только свои** задачи

**Администратор (`role=admin`):**

- Имеет полный доступ ко всем задачам (CRUD `/api/todos`)
- Управляет категориями (CRUD `/api/categories`)

### Проверка владельца задачи

В контроллере задач реализована проверка:

```javascript
if (todo.user_id !== req.user.id && req.user.role !== 'admin') {
  return res.status(403).json({ error: 'Нет доступа' });
}
```

Это гарантирует, что пользователь не может изменить или удалить чужие записи.

## Шаг 5. Интеграция с Passport.js

Для удобной обработки JWT была добавлена стратегия `passport-jwt`.

Основные элементы:

- Passport извлекает токен из заголовка.
- Проверяет его подпись.
- Загружает пользователя из базы.
- Добавляет объект пользователя в `req.user`.

Включение middleware:

```javascript
app.use(passport.authenticate('jwt', { session: false }));
```

После этого доступ к защищённым маршрутам возможен только при наличии корректного токена.

## Шаг 6. Проверка работы (Postman)

| Действие                             | Ожидаемый результат      |
| ------------------------------------ | ------------------------ |
| `user` создаёт задачу                | Успешно                  |
| `user` пытается удалить чужую задачу | `403 Forbidden`          |
| `admin` удаляет любую задачу         | Успешно                  |
| `admin` создаёт категорию            | Успешно                  |
| `user` создаёт категорию             | Ошибка (`403 Forbidden`) |

## Швг 7. Контрольные вопросы

**1. Что такое JWT и как он работает?**
JWT — это токен, содержащий зашифрованные данные о пользователе. Клиент хранит токен и отправляет его при каждом запросе.

**2. Как безопасно хранить пароли?**
Пароли хранятся в виде хэша (`bcrypt`), что исключает восстановление исходного значения.

**3. Разница между аутентификацией и авторизацией:**

- Аутентификация — подтверждение личности пользователя.
- Авторизация — определение прав доступа.

**4. Преимущества Passport.js:**

- Упрощает проверку JWT
- Хорошо интегрируется с Express
- Поддерживает множество стратегий входа

## Шаг 8. Вывод

В ходе выполнения лабораторной работы был модифицирован ToDo REST API:
добавлена система пользователей, реализована аутентификация с использованием JWT, а также авторизация с разграничением прав доступа. Цели работы были успешно достигнуты.
